# 三次握手和四次握手

## 三次握手

* ### \[图片示例\]
* ![](/计算机网络/三次握手图片.png)

### 过程：

* 1、客户端处于closed的状态，建立连接时，回先发送一个建立连接的请求过去，里面包含了SYN=1\(请求同步的信号\)和sequenceNumber=0\(用于对信息包进行排序，保持数据正常连续的一个东西\)等信息，同时客户端会进入SYN\_SEND的状态
* 2、服务端接收到之后，服务端也会发送一个消息还给客户端以表示收到信息，里面包括SYN=1，ACK=1\(这个相当于是表示确认收到的信号\)，ackseq信号（这个信号的数字基于从客户端接收到的seq上+1得到的），seq（服务器首次发出连接的时候也会建立一个seq信号），发出之后服务器会进入SYN\_RECV的状态
* 3、客户端接收到了服务器返回的消息之后，表明连接成功，客户端会再次发送一个信息包到服务器，里面有ACK=1（确认信息），ack \(该值为由上一次服务器发送过来的seq数字的基础上+1\)，发送之后进入established状态，同样服务器接收到之后也会进入到established状态

### 提问：

* 为什么需要三次握手才能建立连接？  
  答：为了初始化sequence Number,保证发送的信息包能正常排序，要双方都知道各自的sequenceNumber，TCP会根据这个号码来拼接数据

* 首次握手的隐患--SYN超时  
  答：可能由于服务端收到了客户端的第一次握手信息并且返回了信息SYC--ACK给客户端之后，客户端再也没有发送信息ACK回来，这时服务端会重复发送SYN--ACK信息给客户端，超过63秒之后断开连接，这样让攻击者可以耗尽链接的时间；解决方案是服务端会在SYN队列满（就是时间耗尽）的时候根据客户端的端口、服务端的端口和时间戳计算一个新的sequenceNumber,也叫SYN——Cookie，将信息打包发送到客户端，攻击者是不会对这个有回应的，只有真正的客户端会识别这个号码，并返回到服务端，开始建立连接

* 假如建立了连接之后还是出现了断开的情况？  
  TCP有个保活的机制，可以会在过了的时间按照一定的频率重新发送信息给客户端，在超过一定的次数之后，客户端仍然没有相应，服务器判断已经失联，服务器也会断开连接，进入关闭状态

## 四次握手

* ### \[图片示例\]

  ![](/三次握手和四次握手/四次握手.png)

### 过程：

* 1、任意一方给另一方主动返送信息取消连接的时候，会首先发送FIN信号、从上面连接继承下来的ACK序号、还有继承下来的Seq号一并发送到被动方，而自身就会开始进入FIN\_wait状态，但是保留可接收数据的状态
* 2、被动方接收到后，回发ACK确认、seq和ack给主动方来确认断连，并开始进入close\_wait状态，并将剩下的数据回传到主动方
* 3、数据传完之后，再次发送信息ACK、seq ack来表示数据已经传输完成，自己开始进入LAST\_ACK状态
* 4、主动方接收到之后，同样会发送ACK seq ack信息确认被动方的数据传输完成，并开始关闭服务，进入Time\_wait状态，一定时间之后就会关闭连接
* 5、被动方接收到主动方关闭连接的回报之后，也会进行关闭。

### 为什么要四次握手断连？

*  因为TCP连接是全双工通信，发送方和接收方都需要FIN报文和ACK报文



