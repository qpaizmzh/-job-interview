# Redis如何做持久化

* ## RDB（快照持久化）：保存某个时间点的全量数据快照

  * ### SAVE：阻塞Redis的服务器进程，直到RDB文件被创建完毕（不推荐，会堵塞Redis主线程，妨碍客户端的请求）
  * ### BGSAVE:Fork出一个子进程来创建RDB文件，不阻塞服务器进程
  * ### ![](/redis/2.png)

## ![](/redis/3.png)RDB持久化的缺点：

缺点：内存数据的全量同步，数据量大会由于I/O而严重影响性能；可能会因为Redis挂掉而丢失从当前最近一次快照期间的数据，如果对数据有不丢失的要求的话，可以采用AOF的方式作为持久化的方式

* ## AOF\(APPEND-ONLY-FILE\)持久化：保存写状态

  * 记录下除了查询以外的所有变更数据库状态的指令

  * 以append的形式追加保存到AOF文件中（增量）

  * 日志重写解决AOF文件大小不断增大的问题，原理如下：

    * 调用fork（），创建一个子进程
    * 子进程把心的AOF写到一个临时文件里，不依赖原来的AOF文件
    * 主进程持续将新的变动同时写到内存和原来的AOF里
    * 主进程获取子进程重写AOF完成的信号，往新的AOF同步增量变动
    * 使用新的AOF文件替换掉旧的AOF文件

  * RDB和AOF文件共存情况下的恢复流程



