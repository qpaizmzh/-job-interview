# 三次握手和四次握手

## 三次握手

* ### \[图片示例\]
* ![](/计算机网络/三次握手图片.png)

* ### 过程：
* 1、客户端处于closed的状态，建立连接时，回先发送一个建立连接的请求过去，里面包含了SYN=1\(请求同步的信号\)和sequenceNumber=0\(用于对信息包进行排序，保持数据正常连续的一个东西\)等信息，同时客户端会进入SYN\_SEND的状态
* 2、服务端接收到之后，服务端也会发送一个消息还给客户端以表示收到信息，里面包括SYN=1，ACK=1\(这个相当于是表示确认收到的信号\)，ackseq信号（这个信号的数字基于从客户端接收到的seq上+1得到的），seq（服务器首次发出连接的时候也会建立一个seq信号），发出之后服务器会进入SYN\_RECV的状态
* 3、客户端接收到了服务器返回的消息之后，表明连接成功，客户端会再次发送一个信息包到服务器，里面有ACK=1（确认信息），ack \(该值为由上一次服务器发送过来的seq数字的基础上+1\)，发送之后进入established状态，同样服务器接收到之后也会进入到established状态

### 提问：

* 为什么需要三次握手才能建立连接？
  答：为了初始化sequence Number,保证发送的信息包能正常排序，要双方都知道各自的sequenceNumber，TCP会根据这个号码来拼接数据

* 首次握手的隐患--SYN超时  
  答：可能由于服务端收到了客户端的第一次握手信息并且返回了信息SYC--ACK给客户端之后，客户端再也没有发送信息ACK回来，这时服务端会重复发送SYN--ACK信息给客户端，超过63秒之后断开连接，这样让攻击者可以耗尽链接的时间；解决方案是服务端会在SYN队列满（就是时间耗尽）的时候根据客户端的端口、服务端的端口和时间戳计算一个新的sequenceNumber,也叫SYN——Cookie，将信息打包发送到客户端，攻击者是不会对这个有回应的，只有真正的客户端会识别



